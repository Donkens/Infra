#################################################################
# Yasse Unbound v3 — Raspberry Pi + AdGuard Home + UDR-7
#
# Roll:
#   • Unbound = "hjärnan" (rekursiv resolver + DNSSEC)
#   • AdGuard = "hudlagret" (blocklist, klienter, UI)
#
# Flöde:
#   Klienter → UDR-7 (192.168.1.1) → AdGuard (192.168.1.55:53)
#   → Unbound (127.0.0.1:5335) → Root/authoritative servrar
#################################################################

server:
  module-config: "validator iterator"
  #################################################################
  # INTERFACE & BAS
  #
  # Unbound ska INTE exponeras direkt i nätet.
  # Endast AdGuard på samma maskin ska prata med den.
  #################################################################
#  interface: 127.0.0.1@5335
#  interface: 192.168.1.55@5335
#  interface: ::1@5335

  # Kör som dedikerad unbound-user (Debian default)
  username: "unbound"
  directory: "/etc/unbound"

  # 2 trådar räcker mer än väl för din Pi
  num-threads: 2
  # Tillåt flera sockets på samma port → smidigare restarts
  so-reuseport: yes

  #################################################################
  # PROTOKOLL / TRANSPORT
  #
  # Tele2 = IPv4-only WAN. Vi låter Unbound använda:
  #   • IPv4: ja (allt går här)
  #   • IPv6: av mot internet (för att slippa timeouts)
  #
  # OBS:
  #  • do-ip6: no = ingen upstream via IPv6
  #  • Du har fortfarande AAAA internt, det är AdGuard/UDR
  #################################################################
  do-ip4: yes
  do-ip6: no
  do-udp: yes
  do-tcp: yes

  # EDNS / UDP-storlek anpassad för moderna nät utan fragmentering
  edns-buffer-size: 1232
  max-udp-size: 1232

  #################################################################
  # CACHE & PRESTANDA
  #
  # • msg-cache-size = metadata om svar
  # • rrset-cache-size = själva RR-seten (A/AAAA/CNAME osv)
  #
  # TTL-inställningar:
  #   • min 120s         → minskar chattigt beteende
  #   • max 86400 (24h)  → bra balans
  #   • negativ TTL 3600 → NXDOMAIN cacheas en stund
  #################################################################
  msg-cache-size: 128m
  rrset-cache-size: 256m

  cache-min-ttl: 300
  cache-max-ttl: 86400
  cache-max-negative-ttl: 300

  # Dra hem populära records innan de går ut
  prefetch: yes
  prefetch-key: yes

  # Använd NSEC/NSEC3 infon mer aggressivt för att
  # cachea "finns inte"-svar
  aggressive-nsec: yes

  # serve-expired = svara ur "gammal" cache om upstream är död
  serve-expired: yes
  serve-expired-ttl: 3600
  serve-expired-reply-ttl: 30
  serve-expired-client-timeout: 1800

  #################################################################
  # SÄKERHET / HÄRDNING
  #
  # • Dölj version/info
  # • Håll koll på ful delegation (harden-glue)
  # • Skydda mot nedstrippad DNSSEC
  # • qname-minimisation = bättre privacy
  #################################################################
  hide-identity: yes
  hide-version: yes

  harden-glue: yes
  harden-dnssec-stripped: yes
  harden-referral-path: no  # warp-test

  qname-minimisation: yes
  qname-minimisation-strict: yes

  # Skydd mot skräp i svar
  unwanted-reply-threshold: 10000

  # 0x20-tricket: slumpa case i query-namn → svårare spoofing
  use-caps-for-id: yes

  #################################################################
  # ACCESS CONTROL — vilka får fråga Unbound?
  #
  # I praktiken är det bara AdGuard lokalt,
  # men vi låter även ditt LAN/ULA ha access om du någon gång
  # vill köra direkt mot Unbound (t.ex. för test).
  #################################################################

  # localhost
  access-control: 127.0.0.0/8 allow
  access-control: ::1/128 allow

  # Main LAN (UDR-7 VLAN 1)
  access-control: 192.168.1.0/24 allow

  # ULA main-LAN (fd12:3456:789a::/64)
  access-control: fd12:3456:789a::/64 allow

  # ULA IoT-LAN (fd12:3456:789b::/64)
  access-control: fd12:3456:789b::/64 allow

  # Om/ när du ger MLO ett eget ULA-prefix, lägg till:
  # access-control: fd12:3456:789c::/64 allow

  #################################################################
  # PRIVATA NÄT — dessa ska ALDRIG skickas ut på internet
  #################################################################
  private-address: 10.0.0.0/8
  private-address: 172.16.0.0/12
  private-address: 192.168.0.0/16
  private-address: fd00::/8
  private-address: fe80::/10

  #################################################################
  # LOGGNIVÅ
  #
  # 0 = tyst, 1–2 = normal debug, 3+ = spam.
  # 2 är en bra balans för dig när du felsöker.
  #################################################################
  verbosity: 2
